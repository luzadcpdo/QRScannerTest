<!DOCTYPE html>
<html>
<head>
  <title>ZCQRScanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 40px auto; 
      position: relative;
      background: #ffffff;
      color: #000000;
      transition: background 0.3s, color 0.3s;
      padding: 10px;
    }
    body.dark { background: #121212; color: #f1f1f1; }

    #topHeader { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; }
    #developer { font-size: 14px; color: #555; }
    body.dark #developer { color: #ccc; }

    #recordsFound {
      font-size: 14px;
      margin-top: 2px;
    }
    #recordsFound span { font-weight: bold; color: blue; }

    #totalRecords { font-weight: normal; }
    #totalRecordsValue { font-weight: bold; }

    #sheetInfo { text-align: right; font-size: 14px; color: #555; }
    body.dark #sheetInfo { color: #bbb; }

    #sheetInfo #status { margin-top: 4px; font-weight: bold; color: green; }
    body.dark #sheetInfo #status { color: #80e080; }

    #searchBox { padding: 8px; width: 50%; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchField { padding: 8px; width: 180px; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchBtn, #clearBtn, #darkModeBtn { 
      padding: 9px 15px; border: none; color: white; cursor: pointer; margin-bottom:10px; border-radius: 5px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #searchBtn { background: #4285F4; margin-right: 5px; }
    #searchBtn:hover { background: #357AE8; }
    #clearBtn { background: #f44336; margin-right: 5px; }
    #clearBtn:hover { background: #d32f2f; }
    #darkModeBtn { background: #333; margin-left: 5px; }
    body.dark #darkModeBtn { background: #666; color: #fff; }

    #validatedMsg { 
      font-weight: bold; 
      display: none; 
      font-size: 22px; 
      margin-top: 10px;
      text-align: center;
    }

    #fields { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd; }
    body.dark #fields { background: #1e1e1e; border-color: #444; }
    .field { display: flex; margin-bottom: 6px; flex-wrap: wrap; }
    .field-name { font-weight: bold; min-width: 200px; color: #333; white-space: nowrap; }
    body.dark .field-name { color: #ddd; }
    .field-value { flex: 1; color: #555; word-wrap: break-word; }
    body.dark .field-value { color: #ccc; }

    #counter { margin-top: 10px; font-weight: bold; color: #444; }
    body.dark #counter { color: #ccc; }

    #results { margin-top: 10px; border-collapse: collapse; width: 100%; overflow-x:auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; word-wrap: break-word; }
    th { background-color: #4285F4; color: white; font-weight: bold; text-align: left; }
    tr:hover { background-color: #e8f0fe; cursor: pointer; }
    body.dark th { background-color: #333; border-color: #555; }
    body.dark td { border-color: #555; }
    body.dark tr:hover { background-color: #444; }
  </style>
</head>
<body>
  <div id="topHeader">
    <div>
      <div id="developer">Developer: Rodney Belangdal</div>
      <div id="recordsFound">Records Found: <span id="recordsCount">0</span></div>
    </div>
    <div id="sheetInfo">
      <div id="totalRecords">Total Records: <span id="totalRecordsValue">0</span></div>
      <div id="sheetName">&nbsp;</div>
      <div id="status">Loading dataâ€¦</div>
    </div>
  </div>

  <h2>LUZAD ZONING CERTIFICATION VERIFICATION @ CPDO2025</h2>
  <select id="searchField"></select>
  <input type="text" id="searchBox" placeholder="Search..." disabled />
  <button id="searchBtn" disabled>Search</button>
  <button id="clearBtn">Clear</button>
  <button id="darkModeBtn">ðŸŒ™ Dark Mode</button>

  <div id="validatedMsg"></div>

  <div id="fields">
    <div class="field"><span class="field-name">DATE RECEIPT :</span><span class="field-value" id="DATE RECEIPT">&nbsp;</span></div>
    <div class="field"><span class="field-name">RELEASED DATE :</span><span class="field-value" id="RELEASED_D">&nbsp;</span></div>
    <div class="field"><span class="field-name">CONTROL NO :</span><span class="field-value" id="CONTROL NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">PIN :</span><span class="field-value" id="PIN">&nbsp;</span></div>
    <div class="field"><span class="field-name">NEW PIN :</span><span class="field-value" id="NEW PIN">&nbsp;</span></div>
    <div class="field"><span class="field-name">APPLICANT NAME :</span><span class="field-value" id="APPLICANT NAME">&nbsp;</span></div>
    <div class="field"><span class="field-name">LOT/SURVEY NO :</span><span class="field-value" id="LOT/SURVEY NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">LAND AREA :</span><span class="field-value" id="LAND AREA">&nbsp;</span></div>
    <div class="field"><span class="field-name">BARANGAY :</span><span class="field-value" id="BARANGAYID_F">&nbsp;</span></div>
    <div class="field"><span class="field-name">ZONE CLASS :</span><span class="field-value" id="CLASSIFICATIONID_F">&nbsp;</span></div>
    <div class="field"><span class="field-name">PLUSCODE :</span><span class="field-value" id="PLUSCODES">&nbsp;</span></div>
    <div class="field"><span class="field-name">OR NO :</span><span class="field-value" id="OR NO">&nbsp;</span></div>
    <div class="field"><span class="field-name">OR DATE :</span><span class="field-value" id="OR DATE">&nbsp;</span></div>    
    <div class="field"><span class="field-name">REMARKS :</span><span class="field-value" id="REMARKS">&nbsp;</span></div>
  </div>

  <div id="counter"></div>
  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const apiURL = "https://script.google.com/macros/s/AKfycbzl2hyJ6R807HCLGRZXPgniqPhuHpxJpSIEzy3cXE-W9Otnr6RUGh5L9TxB7OMgns3i/exec";
    let sheetData = [];
    let totalRecords = 0;

    const FIELDS_TO_SHOW = [ "DATE RECEIPT", "RELEASED_D", "CONTROL NO", "PIN", "NEW PIN", "APPLICANT NAME", "LOT/SURVEY NO", "LAND AREA", "BARANGAYID_F", "CLASSIFICATIONID_F", "PLUSCODES", "OR NO", "OR DATE", "REMARKS" ];
    const SEARCHABLE_FIELDS = [ "CONTROL NO", "PIN", "NEW PIN", "APPLICANT NAME", "LOT/SURVEY NO" ];

    const dropdown = document.getElementById("searchField");
    SEARCHABLE_FIELDS.forEach(field => {
      const option = document.createElement("option");
      option.value = field;
      option.textContent = field;
      dropdown.appendChild(option);
    });

    const searchBox = document.getElementById("searchBox");
    const searchBtn = document.getElementById("searchBtn");

    function formatLongDate(value) {
      if (!value) return "\u00A0";
      const date = new Date(value);
      if (isNaN(date)) return value;
      const options = { year: 'numeric', month: 'long', day: '2-digit' };
      return date.toLocaleDateString('en-US', options);
    }

    async function loadData() {
      const statusDiv = document.getElementById("status");

      searchBox.disabled = true;
      searchBtn.disabled = true;
      statusDiv.textContent = "Loading dataâ€¦";

      try {
        const res = await fetch(apiURL);
        const rawData = await res.json();
        const headers = rawData.data[0];
        sheetData = rawData.data.slice(1).map(row => {
          let obj = {};
          headers.forEach((h, i) => obj[h] = row[i]);
          return obj;
        });
        totalRecords = sheetData.length;
        document.getElementById("totalRecordsValue").textContent = totalRecords;
        document.getElementById("sheetName").textContent = rawData.spreadsheetName || "Unknown Sheet";
        document.getElementById("recordsCount").textContent = 0;

        statusDiv.textContent = "Data loaded. You can now search.";

        searchBox.disabled = false;
        searchBtn.disabled = false;
      } catch(err) {
        statusDiv.textContent = "Failed to load data.";
        searchBox.disabled = true;
        searchBtn.disabled = true;
      }
    }

    function fillFields(row) {
      FIELDS_TO_SHOW.forEach(field => {
        const el = document.getElementById(field);
        if (!el) return;
        let value = row[field] || "\u00A0";
        if (field === "DATE RECEIPT" || field === "RELEASED_D" || field === "OR DATE") {
          value = formatLongDate(value);
        }
        el.textContent = value;
      });
    }

    function clearFields() {
      FIELDS_TO_SHOW.forEach(field => {
        const el = document.getElementById(field);
        if (el) el.textContent = "\u00A0";
      });
    }

    function showResults(data) {
      const resultsDiv = document.getElementById("results");
      const counterDiv = document.getElementById("counter");
      resultsDiv.innerHTML = "";
      counterDiv.textContent = `Showing ${data.length} of ${totalRecords} record(s)`;

      document.getElementById("recordsCount").textContent = data.length;

      if (!data.length) return;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["CTRL NO", "APPLICANT", "LOT/SURVEY NO", "ZONE CLASS", "BARANGAY"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        ["CONTROL NO", "APPLICANT NAME", "LOT/SURVEY NO", "CLASSIFICATIONID_F", "BARANGAYID_F"].forEach(col => {
          const td = document.createElement("td");
          td.textContent = row[col] || "";
          tr.appendChild(td);
        });
        tr.addEventListener("click", () => fillFields(row));
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      resultsDiv.appendChild(table);
    }

    function clearResults() {
      document.getElementById("results").innerHTML = "";
      document.getElementById("counter").textContent = "";
      document.getElementById("validatedMsg").style.display = "none";
      document.getElementById("recordsCount").textContent = 0;
    }

    function flashRed() {
      document.body.style.background = "#ffcccc";
      setTimeout(() => { document.body.style.background = ""; }, 200);
    }

    function runSearch(fromTyping = false) {
      clearResults();
      clearFields();

      if (!sheetData.length) return;
      const query = searchBox.value.trim().toLowerCase();
      const selectedField = dropdown.value;
      const validatedMsg = document.getElementById("validatedMsg");

      if (!query) {
        validatedMsg.style.display = "none";
        return;
      }

      const filtered = sheetData.filter(row => row[selectedField] && String(row[selectedField]).trim().toLowerCase() === query);
      showResults(filtered);

      if (filtered.length > 0) {
        fillFields(filtered[0]);
        validatedMsg.textContent = "VERIFIED DATA!";
        validatedMsg.style.color = "green";
        validatedMsg.style.display = "block";
        if (fromTyping) playBeep("success");
      } else {
        validatedMsg.textContent = "NO RECORD FOUND!";
        validatedMsg.style.color = "red";
        validatedMsg.style.display = "block";
        if (fromTyping) { playBeep("error"); flashRed(); }
      }
    }

    function clearSearch() {
      searchBox.value = "";
      clearResults();
      clearFields();   
    }

    let typingTimer;
    const typingDelay = 1000; 
    searchBox.addEventListener("input", () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => { runSearch(true); }, typingDelay);
    });

    searchBtn.addEventListener("click", () => runSearch(true));
    clearBtn.addEventListener("click", clearSearch);
    darkModeBtn.addEventListener("click", () => document.body.classList.toggle("dark"));

    function playBeep(type="success") {
      try {
        if (!window.beepAudioCtx) window.beepAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = window.beepAudioCtx;
        const oscillator = ctx.createOscillator();
        oscillator.type = "square";
        oscillator.frequency.value = type === "success" ? 1000 : 300; 
        oscillator.connect(ctx.destination);
        oscillator.start();
        oscillator.stop(ctx.currentTime + 0.12);
      } catch(e) {}
    }

    window.addEventListener("load", loadData);
  </script>
</body>
</html>
